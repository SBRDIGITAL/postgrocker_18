# Postgrocker Local

## Навигация:
- [О проекте](#локальный-postgresql-с-кастомными-параметрами-через-docker-compose)
- [Клонирование](#шаг-1-клонирование-репозитория)
- [.env](#шаг-2-создание-файла-env)
- [Логи](#шаг-3-подготовка-директории-для-логов)
- [Запуск](#шаг-4-запуск-базы-данных)
- [Подключение](#подключение-к-базе-данных)
- [Проверка логов](#шаг-6-проверка-логов)
- [Остановка](#шаг-7-остановка-и-удаление-контейнера)
- [Гайд по новинкам 18](#заключение)

- Гайд по новинкам PostgreSQL 18 и примерам: см. `POSTGRES18_GUIDE.md`

## Локальный PostgreSQL с кастомными параметрами через Docker Compose
Этот проект позволяет запустить PostgreSQL с пользовательскими параметрами, которые задаются прямо в `docker-compose.yml` через командную строку.
Все параметры конфигурации теперь явно прописаны и легко изменяются.
- **[Использует параметры взятые от сюда](https://www.pgconfig.org/)**

### Шаг 1: Клонирование репозитория
Сначала клонируйте репозиторий на ваш локальный компьютер. Откройте терминал и выполните следующую команду:
```bash
git clone https://github.com/SBRDIGITAL/postgrocker_18.git
```

### Шаг 2: Создание файла `.env`
Перейдите в директорию проекта:
```bash
cd postgrocker_18
```

Создайте файл `.env` в корневой директории проекта и укажите нужные вам значения переменных:
```bash
cp .env.template .env
```
Заполните
```env
POSTGRES_DB=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_PORT=5435
```

### Шаг 3: Подготовка директории для логов (ОБЯЗАТЕЛЬНО)
Перед запуском контейнера вручную выполните скрипт, который создаст директорию логов и выставит правильные права для пользователя контейнера (UID 999):

```bash
sudo bash ./setup_db_logs.sh
```

Что делает скрипт:
- создает каталог `./db_logs` (если его нет);
- выставляет владельца `999:999` (пользователь Postgres в контейнере);
- устанавливает права `755`, чтобы контейнер мог писать логи.

##### НА СЛУЧАЙ ЕСЛИ ТОМ ЛОКАЛЬНЫЙ, ТО НАДО СОЗДАТЬ ДИРЕКТОРИЮ ЗАРАНЕЕ И НАСТРОИТЬ ПРАВА
```bash
mkdir -p ./postgres_data
sudo chown -R 999:999 ./postgres_data
sudo chmod -R 755 ./postgres_data
```

**Важно!** PostgreSQL контейнер работает от пользователя с UID 999, поэтому необходимо дать права этому пользователю на запись в директорию логов.

### Шаг 4: Запуск базы данных
Убедитесь, что у вас установлен `Docker` и `Docker Compose`. Затем выполните следующую команду в терминале для запуска контейнера:
```bash
docker-compose up -d
```
Флаг `-d` запускает контейнер в фоновом режиме.

**Перед запуском обязательно замените в файле `docker-compose.yml`:**

| Что менять         | Где менять                | Пример                |
|--------------------|--------------------------|-----------------------|
| Название сервиса   | services: <имя_сервиса>  | postgrocker           |
| container_name     | container_name: <имя>    | postgrocker           |
| networks           | networks: <имя_сети>     | postgrocker_network   |

Задайте свои уникальные значения, чтобы избежать конфликтов и сделать конфигурацию более читаемой.

### Кастомные параметры PostgreSQL
Все параметры конфигурации теперь задаются в файлах `postgresql.conf` и `pg_hba.conf`, которые монтируются в контейнер. Секция `command:` в `docker-compose.yml` лишь указывает путь к основному конфигурационному файлу.

| Параметр                      | Значение      | Назначение/Описание |
|-------------------------------|--------------|---------------------|
| shared_buffers                | 1GB          | Размер буфера памяти для страниц БД |
| effective_cache_size          | 4GB          | Оценка доступного кэша ОС для PostgreSQL |
| work_mem                      | 13MB         | Память на одну сортировку/операцию |
| maintenance_work_mem          | 256MB        | Память для операций обслуживания (VACUUM, CREATE INDEX) |
| min_wal_size                  | 2GB          | Минимальный размер WAL сегментов |
| max_wal_size                  | 3GB          | Максимальный размер WAL сегментов |
| checkpoint_completion_target  | 0.9          | Доля времени между чекпоинтами |
| wal_buffers                   | -1           | Размер буфера WAL (автоматически) |
| max_connections               | 100          | Максимальное число одновременных подключений |
| random_page_cost              | 1.1          | Оценка стоимости случайного чтения страницы |
| effective_io_concurrency      | 200          | Количество одновременных операций ввода-вывода |
| max_worker_processes          | 8            | Максимум воркеров для параллельных задач |
| max_parallel_workers_per_gather | 2         | Воркеры для параллельных запросов |
| max_parallel_workers          | 2            | Общий лимит параллельных воркеров |
| logging_collector             | on           | Включить сбор логов в файлы |
| log_checkpoints               | on           | Логировать чекпоинты |
| log_connections               | on           | Логировать подключения |
| log_disconnections            | on           | Логировать отключения |
| log_lock_waits                | on           | Логировать ожидания блокировок |
| log_temp_files                | 0            | Логировать все временные файлы |
| lc_messages                   | 'C'          | Язык сообщений сервера |
| log_min_duration_statement    | '10s'        | Логировать запросы дольше 10 секунд |
| log_autovacuum_min_duration   | 0            | Логировать все autovacuum |
| log_destination               | 'csvlog'     | Формат логов (CSV для pgbadger) |

Все параметры можно изменить в `postgresql.conf`, а правила доступа — в `pg_hba.conf`.

### Подключение к базе данных
- Контейнер: `postgrocker_18`, хост: `127.0.0.1`, порт: `5435`, auth: SCRAM, данные в именованном томе `postgrocker_18_postgrocker_data`.
- Подключение с хоста (psql):
```bash
psql -h 127.0.0.1 -p 5435 -U "$POSTGRES_USER" -d "$POSTGRES_DB"
```
- Из контейнера:
```bash
docker compose exec postgrocker_18 psql -U "$POSTGRES_USER" -d "$POSTGRES_DB"
```
- Логи: `docker compose logs -f postgrocker_18` (файлы — `./db_logs`).

### Шаг 5: Проверка работы базы данных
После успешного запуска контейнера вы можете подключиться к базе данных `PostgreSQL` с помощью любого клиента, используя следующие параметры подключения:
- **Хост**: `localhost`
- **Порт**: `5435`
- **Имя базы данных**: `postgrocker_db`
- **Пользователь**: `postgrocker_user`
- **Пароль**: `your_password` (замените на ваш пароль)

Пример подключения через psql:
```bash
psql -h localhost -p 5435 -U postgres -d postgres
```

### Шаг 6: Проверка логов
После запуска контейнера проверьте, что логи создаются в директории `./db_logs`:
```bash
ls -l ./db_logs
```
Должны появиться файлы логов в формате: `postgresql-2025-09-04_123000.log`

### Шаг 7: Остановка и удаление контейнера
Чтобы остановить контейнер, выполните команду:
```bash
docker-compose down
```
Это остановит контейнеры, созданные `Docker Compose`.

### Решение возможных проблем

#### Проблема 1: Permission denied при создании логов
**Симптомы:** Контейнер не может создать лог-файлы в директории `./db_logs`

**Решение:** 
1. Создайте директорию и настройте правильные права:
```bash
mkdir -p ./db_logs
sudo chown -R 999:999 ./db_logs
sudo chmod -R 755 ./db_logs
```

2. Если проблема сохраняется, попробуйте альтернативный вариант:
```bash
sudo chown -R $(id -u):$(id -g) ./db_logs
```

3. Перезапустите контейнер:
```bash
docker-compose down
docker-compose up -d
```

**Объяснение:** PostgreSQL контейнер работает от пользователя с UID 999, который должен иметь права на запись в примонтированную директорию логов.

#### Проблема 2: Логи не появляются в директории
**Симптомы:** Контейнер запустился, но файлы логов не создаются

**Решение:**
1. Проверьте, что контейнер перенаправляет логи:
   - В выводе должна быть строка: `LOG: redirecting log output to logging collector process`
   
2. Выполните действия в базе данных (подключение, запрос) для генерации событий

3. Проверьте конфигурацию логирования в `docker-compose.yml`:
   - `log_destination='csvlog'`
   - `logging_collector=on`
   - Правильный путь в `volumes: - ./db_logs:/var/log/postgresql`

### Заключение
Теперь у вас есть локальная `PostgreSQL`, работающая в контейнере `Docker`.
Вы можете использовать эту базу данных для разработки и тестирования ваших приложений.